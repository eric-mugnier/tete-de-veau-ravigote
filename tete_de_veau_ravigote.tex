\documentclass[10pt,a5paper,twoside,openright]{memoir}

% ─── PACKAGES ─────────────────────────────────────────────────────────────────
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{ebgaramond}
\usepackage[french]{babel}
\usepackage{microtype}
\usepackage{fmtcount}
\usepackage{catchfile}
\usepackage{graphicx}
\usepackage{xcolor}
\usepackage{tikz}
\input{version.tex}
\immediate\write18{git log -1 --format=\%h > \jobname.gitinfo}
\CatchFileDef{\gitcommit}{\jobname.gitinfo}{\endlinechar=-1}

% ─── NOTES FINALES ─────────────────────────────────────────────────────────────
% Compiler avec : pdflatex "\def\AVECNOTES{}\input{tete_de_veau_ravigote}"
\usepackage{endnotes}
\ifdefined\AVECNOTES
  \newcommand{\nf}[1]{\endnote{#1}}
\else
  \newcommand{\nf}[1]{}
\fi
% Supprimer le titre automatique du package (on gère le nôtre)
\renewcommand{\notesname}{}
% Style des notes : même fonte, corps légèrement réduit
\renewcommand{\enotesize}{\small}
% Format des notes en fin de livre :
%   – sans retrait (parindent=0, pas de \llap)
%   – numéro en corps normal, non exposant (\theenmark sans \@textsuperscript)
\makeatletter
\renewcommand\enoteformat{%
  \rightskip\z@ \leftskip\z@ \parindent=0pt
  \leavevmode\theenmark.\enspace}
\makeatother
% Source dans les notes : saut de ligne avant le lien Wikipedia
\newcommand{\source}[1]{\newline\textit{Source~:} \textup{#1}}
% Titre de chapitre dans le bloc de notes (commande nommée pour éviter que
% \scshape soit fusionné avec le texte suivant lors du \write dans .ent)
\newcommand{\chapnoteheader}[1]{{\normalfont\scshape #1}}
% Notes par chapitre regroupées en fin de livre :
%   – injecte un titre de chapitre dans le flux .ent
%   – remet le compteur à 0 pour que chaque acte reparte de 1
\newcommand{\beginchapternotes}[1]{%
  \ifdefined\AVECNOTES
    \setcounter{endnote}{0}%
    \addtoendnotes{\protect\par\protect\medskip\protect\noindent\protect\chapnoteheader{#1}\protect\par}%
  \fi
}

% ─── PAGE GEOMETRY (140×205 mm – Gallimard Blanche) ──────────────────────────
\setstocksize{210mm}{148mm}
\settrimmedsize{210mm}{148mm}{*}
\settrims{0mm}{0mm}
\setlrmarginsandblock{22mm}{17mm}{*} % inner/outer
\setulmarginsandblock{22mm}{25mm}{*} % top/bottom
\setheadfoot{10mm}{12mm}
\setheaderspaces{*}{6mm}{*}
\checkandfixthelayout

% ─── TYPOGRAPHY ───────────────────────────────────────────────────────────────
\raggedbottom                        % Pages courtes autorisées (fins de chapitre)
\renewcommand{\baselinestretch}{1.1} % Interligne
\setlength{\parindent}{4mm}          % Alinéa
\setlength{\parskip}{0pt}            % Pas d'espace entre paragraphes

% Pas d'alinéa après titres de chapitre
\setlength{\afterchapskip}{0.4\onelineskip} % réduit : la headline gère l'espace vers le texte

% ─── HEADLINES DE CHAPITRES ───────────────────────────────────────────────────
% Petites capitales, corps réduit, dans un bloc aux marges intérieures élargies
\newcommand{\chaptersummary}[1]{%
  \edef\chapnum{\ifcase\value{chapter}\or I\or II\or III\or IV\or V\or VI\or VII\or VIII\or IX\fi}%
  \addtocontents{toc}{\protect\setcounter{tocdepth}{0}}%
  \addcontentsline{toc}{chapter}{\protect\tocchapnum{\chapnum}#1}%
  \addtocontents{toc}{\protect\setcounter{tocdepth}{-1}}%
}
% Résumé de partie intercalé dans le corps du texte (acte 9 parties 2–4)
\newcommand{\partsummary}[1]{%
  \addtocontents{toc}{\protect\setcounter{tocdepth}{1}}%
  \addcontentsline{toc}{section}{\protect\tocchapsep#1}%
  \addtocontents{toc}{\protect\setcounter{tocdepth}{-1}}%
}

% ─── TABLE DES MATIÈRES ───────────────────────────────────────────────────────
\setcounter{tocdepth}{-1}% supprime toutes les entrées automatiques des \chapter{}
\AtBeginDocument{\addtocontents{toc}{\protect\setcounter{tocdepth}{-1}}}
\addto\captionsfrench{\renewcommand{\contentsname}{Sommaire}}
\renewcommand{\printtoctitle}[1]{%
  \null\vskip 2\onelineskip%
  {\centering\normalfont\scshape\large #1\par}%
}
\renewcommand{\aftertoctitle}{\vskip 2\onelineskip}
% Colonnes du sommaire : numéro romain (gauche) + texte (droite)
\newcommand{\tocchapnum}[1]{\hbox to 2.5em{#1\hfil}}% boîte fixe pour le numéro
\newcommand{\tocchapsep}{\hbox to 2.5em{\hfil}}% boîte vide pour les sous-chapitres
% Entrées de chapitre (ajoutées manuellement via \chaptersummary)
\renewcommand{\cftchapterfont}{\small\scshape}
\renewcommand{\cftchapterpagefont}{\small\scshape}
\setlength{\cftchapterindent}{0pt}
\setlength{\cftchapternumwidth}{2.5em}% retrait de continuation = largeur de la colonne gauche
\setlength{\cftbeforechapterskip}{0.5\onelineskip}
% Entrées de section (ajoutées manuellement via \partsummary)
\renewcommand{\cftsectionfont}{\small\scshape}
\renewcommand{\cftsectionpagefont}{\small\scshape}
\setlength{\cftsectionindent}{0pt}
\setlength{\cftsectionnumwidth}{2.5em}% même retrait de continuation
\setlength{\cftbeforesectionskip}{0.2\onelineskip}

% ─── CHAPTER STYLE ────────────────────────────────────────────────────────────
\makeatletter
\makechapterstyle{gallimard}{%
  \renewcommand{\chapnamefont}{\normalfont\scshape\centering}
  \renewcommand{\chapnumfont}{\normalfont\scshape\centering}
  \renewcommand{\chaptitlefont}{\normalfont\scshape\centering}
  \renewcommand{\printchaptername}{}
  \renewcommand{\chapternamenum}{}
  \renewcommand{\printchapternum}{%
    \chapnumfont\Roman{chapter}} % numéro en chiffres romains
  \renewcommand{\afterchapternum}{\par\vskip 0.4\onelineskip}
  \renewcommand{\printchaptertitle}[1]{}
}
\makeatother
\chapterstyle{gallimard}

% ─── RUNNING HEADERS : folio seul, sans auteur ni titre ───────────────────────
\makepagestyle{gallimard}
\makeevenhead{gallimard}{}{}{}        % en-tête paire : vide
\makeoddhead{gallimard}{}{}{}         % en-tête impaire : vide
\makeevenfoot{gallimard}{}{\thepage}{}
\makeoddfoot{gallimard}{}{\thepage}{}
\makepsmarks{gallimard}{%
  \nouppercaseheads
  \createmark{chapter}{both}{nonumber}{}{}
}
\pagestyle{gallimard}

% Pages de début de chapitre : sans en-tête ni folio
\aliaspagestyle{chapter}{empty}

% Pages blanches intercalées par \cleardoublepage : toujours vides
\makeatletter
\renewcommand{\cleardoublepage}{%
  \clearpage
  \if@twoside
    \ifodd\c@page\else
      \hbox{}\thispagestyle{empty}\newpage
    \fi
  \fi
}
\makeatother

% ─── DOCUMENT ─────────────────────────────────────────────────────────────────
\begin{document}
\pagestyle{empty}

% ═══ PAGE DE TITRE (p. 1, impaire) ═══════════════════════════════════════════
\begin{center}
\vspace*{6\onelineskip}
{\scshape\large éric mugnier}

\vspace{8\onelineskip}
{\scshape\huge tête de veau ravigote}

\vspace{12\onelineskip}
{\itshape roman}
\end{center}
% ═══ PAGE DE COPYRIGHT (verso du titre, p. 2) ════════════════════════════════
\newpage
\thispagestyle{empty}
\vspace*{\fill}
{\footnotesize\noindent
\textcopyright{} Éric Mugnier, 2026\\
Tous droits réservés pour tous pays\\
Reproduction interdite
}
\cleardoublepage                        % p. 5 (impaire) → dédicace

% ═══ DÉDICACE (impaire) ═══════════════════════════════════════════════════════
\vspace*{10\onelineskip}
\begin{flushright}
\itshape\small
À ma grand-mère maternelle Alexandrine Chéron, née Lemaître, \\
décédée en 2022 alors qu'elle survolait la cordillère des Andes \\
à bord du Cessna Skylane 182 jaune canari qu'elle s'était, \\
contre l'avis général et tout particulièrement celui des compagnies \\
d'assurances (qui, bien qu'elle soit en pleine forme, la jugeait \\
tout de même peut-être un peu âgée pour piloter), offert en grande \\
pompe pour son quatre-vingt-septième anniversaire. Le crash aérien, \\
d'une extrême violence, n'a pas permis de retrouver l'intégralité \\
des morceaux de la chère vieille dame, en partie calcinée et dévorée \\
par les condors qui, on ne le sait pas assez, adorent la viande bien \\
cuite. Sa mort laisse un grand vide dans mon cœur.
\end{flushright}
\cleardoublepage                        % p. 6 blanche, → p. 7 (impaire) chapitre 1

% ═══ MAIN TEXT ════════════════════════════════════════════════════════════════
\pagestyle{gallimard}

% Ouvre le .toc en écriture pour le sommaire séparé.
% Le document principal n'affiche pas de table des matières, mais \@starttoc
% doit être appelé pour que \addcontentsline écrive dans le fichier .toc.
% \contentsline est temporairement neutralisé pour ne rien imprimer lors de
% la lecture de l'ancien .toc.
{\makeatletter\def\contentsline#1#2#3#4{}\@starttoc{toc}\makeatother}

\input{tete_de_veau_ravigote_content.tex}

% ═══ NOTES FINALES (incluses ssi \AVECNOTES défini) ═══════════════════════════
\ifdefined\AVECNOTES
  \cleardoublepage                              % p. impaire : page-titre « Notes »
  \thispagestyle{empty}
  \vspace*{10\onelineskip}
  {\centering\normalfont\scshape\large Notes\par}
  \newpage                                      % p. paire : blanche
  \hbox{}\thispagestyle{empty}
  \newpage                                      % p. impaire : début des notes
  \pagestyle{gallimard}
  \theendnotes
\fi

% ═══ COLOPHON FINAL (page impaire) + PAGE BLANCHE FINALE (page paire) ════════
\clearpage
\hbox{}\thispagestyle{empty}\newpage   % page blanche intercalée après le texte
% \makeatletter requis : @ a catcode 12 dans le corps du document.
% Si la prochaine page est paire, on insère une page blanche pour
% que le colophon tombe sur une page impaire (recto).
\makeatletter
\ifodd\c@page\else
  \hbox{}\thispagestyle{empty}\newpage
\fi
\makeatother
\thispagestyle{empty}
\null\vfill
{\footnotesize
\hbox to \linewidth{\hfil\tikz\node[opacity=0.33,inner sep=0pt]{\includegraphics[height=1.6\onelineskip]{images/ct_watermark.png}};}\par\vspace{-6pt}
\noindent{\color{black!33}\rule{\linewidth}{0.4pt}}\par\vspace{6pt}

% Ligne 1 — justifiée naturellement
\noindent\textit{Troisième édition, préparée par Christophe Thiebaud à San Lazzaro di Savena, le 25 février 2026}\linebreak

% Ligne 2 — logos justifiés gauche / droite
\noindent\hbox to \linewidth{%
\raisebox{-0.8ex}{\includegraphics[height=3ex]{images/github-repo-git-octocat-svgrepo-com.svg.pdf}} \texttt{\gitcommit}%
\hfill
\textup{\LaTeX}%
}

}
\newpage
\hbox{}\thispagestyle{empty}

\end{document}
